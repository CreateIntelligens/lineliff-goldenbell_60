<template>
  <div class="generation-records w-full min-h-screen bg-white relative sm:max-w-[393px] sm:mx-auto">
    <!-- Background Image -->
    <div class="absolute inset-0 w-full min-h-full">
      <img 
        :src="backgroundImage" 
        :alt="eventType === 'award_speech' ? 'Award Speech Background' : 'Golden Bell Background'"
        class="w-full h-full min-h-screen object-cover"
      />
    </div>

    <!-- Status Bar (Optional) -->
    <div class="flex w-full h-[47px] justify-center items-center relative z-10">
    </div>

    <!-- Main Container -->
    <div class="flex w-full h-[781px] pt-[24px] px-[20px] flex-col items-start gap-[24px] relative z-10">
      <!-- Header -->
      <PageHeader
        :title="pageTitle"
        :showBadge="true"
        :badgeText="`已生成：${generatedCount}/10`"
        @goBack="goBack"
      />

      <!-- Records Container -->
      <div class="flex flex-col items-start gap-[16px] w-full overflow-y-auto">
        <!-- Loading State -->
        <div v-if="isLoading" class="flex flex-col items-center justify-center w-full py-20">
          <div class="text-white text-center opacity-60">
            <div class="text-lg mb-2">載入中...</div>
            <div class="text-sm">
              {{ eventType === 'award_speech' ? '正在獲取您的感言卡記錄' : '正在獲取您的應援海報記錄' }}
            </div>
          </div>
        </div>

        <!-- Error State -->
        <div v-else-if="apiError" class="flex flex-col items-center justify-center w-full py-20">
          <div class="text-red-400 text-center">
            <div class="text-lg mb-2">載入失敗</div>
            <div class="text-sm">{{ apiError }}</div>
            <button 
              @click="loadImageHistory"
              class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            >
              重新載入
            </button>
          </div>
        </div>

        <!-- Empty State -->
        <div v-else-if="records.length === 0" class="flex flex-col items-center justify-center w-full py-20">
          <div class="text-white text-center opacity-60">
            <div class="text-lg mb-2">
              {{ eventType === 'award_speech' ? '尚未生成任何感言卡' : '尚未生成任何海報' }}
            </div>
            <div class="text-sm">
              {{ eventType === 'award_speech' ? '開始創建您的第一張專屬感言卡吧！' : '開始創建您的第一張應援海報吧！' }}
            </div>
          </div>
        </div>
        
        <!-- History grid -->
        <div v-else class="grid grid-cols-2 gap-3 max-w-md mx-auto w-full">
          <div 
            v-for="(item, index) in records" 
            :key="item.id || index"
            class="flex w-full h-40 p-4 items-center gap-3 bg-[#6A6A6A] rounded-[5px] cursor-pointer hover:bg-[#7A7A7A] transition-colors"
            @click="viewHistoryItem(item)"
          >
            <div class="flex w-full flex-col items-start gap-3">
              <!-- 海報圖片區域 -->
              <div class="relative h-24 w-full rounded overflow-hidden">
                <img 
                  v-if="getHistoryImage(item)"
                  :src="getHistoryImage(item)" 
                  :alt="`生成圖片 ${index + 1}`" 
                  class="h-full w-full object-cover"
                  @error="handleImageError"
                />
                <div v-else class="h-full w-full bg-[#444444] flex items-center justify-center">
                  <span class="text-[#999999] text-xs">無圖片</span>
                </div>
                
                <!-- 文字覆蓋層 - 根據事件類型調整位置 -->
                <div v-if="item.text" :class="getTextOverlayClass()" class="absolute p-1">
                  <div :class="getTextContainerClass()">
                    <div :class="getTextClass()" :style="getTextStyle()">
                      {{ item.text }}
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 時間戳記 -->
              <div class="text-white font-normal text-xs">
                {{ formatDate(item.created_at || item.date || item.timestamp) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
import { defineEmits, computed, onMounted, ref, watch } from 'vue'
import PageHeader from './PageHeader.vue'
import { apiService } from '../../services/apiService.js'
import { getCurrentEventType } from '../../config/themeConfig.js'
import { getThemeImages } from '../../assets/images.js'

// Props
const props = defineProps({
  records: {
    type: Array,
    default: () => []
  },
  refreshTrigger: {
    type: Number,
    default: 0
  }
})

// Emits
const emit = defineEmits(['goBack', 'viewItem'])

// Reactive data
const apiRecords = ref([])
const isLoading = ref(false)
const apiError = ref('')
const eventType = getCurrentEventType() // 動態獲取當前事件類型


// Computed properties
const records = computed(() => {
  // 優先使用從 API 載入的記錄，如果沒有則使用 props
  return apiRecords.value.length > 0 ? apiRecords.value : props.records
})

const generatedCount = computed(() => records.value.length)

// 根據 event_type 動態標題
const pageTitle = computed(() => {
  return eventType === 'award_speech' ? '專屬感言卡生成紀錄' : '應援海報生成紀錄'
})

// 根據 event_type 動態背景圖片
const backgroundImage = computed(() => {
  const themeImages = getThemeImages(eventType)
  return themeImages.detailBackground  // 使用 detailBackground (award_background.png)
})

// 生命週期
onMounted(async () => {
  await loadImageHistory()
})

// 監聽 refreshTrigger 變化，重新載入資料
watch(() => props.refreshTrigger, async (newValue, oldValue) => {
  if (newValue !== oldValue && newValue > 0) {
    console.log('🔄 收到刷新請求，重新載入歷史記錄...')
    await loadImageHistory()
  }
})

// Methods
/**
 * 載入圖片歷史記錄
 */
const loadImageHistory = async () => {
  
  if (!apiService.isApiAvailable()) {
    console.warn('⚠️ API 服務不可用')
    apiError.value = 'API 服務暫時不可用，請稍後再試'
    return
  }

  try {
    isLoading.value = true
    apiError.value = ''
    
    
    const result = await apiService.getImageHistory(eventType)
    
    
    if (result) {
      // 根據不同的 API 回應格式處理數據
      let historyData = []
      
      // 嘗試多種可能的資料路徑
      let rawData = null
      if (result.result && result.result.data) {
        rawData = result.result.data
      } else if (result.data) {
        rawData = result.data
      } else if (result.result) {
        rawData = result.result
      } else {
        rawData = result
      }
      
      if (typeof rawData === 'string') {
        try {
          historyData = JSON.parse(rawData)
        } catch (e) {
          console.warn('⚠️ 無法解析歷史記錄數據:', rawData)
          historyData = []
        }
      } else if (Array.isArray(rawData)) {
        historyData = rawData
      } else if (rawData && typeof rawData === 'object') {
        // 如果是物件，嘗試查找陣列屬性
        const possibleArrayKeys = ['data', 'items', 'records', 'list']
        for (const key of possibleArrayKeys) {
          if (Array.isArray(rawData[key])) {
            historyData = rawData[key]
            break
          }
        }
        if (historyData.length === 0) {
          console.warn('⚠️ 無法在物件中找到陣列資料')
        }
      } else {
        console.warn('⚠️ 無法處理的資料格式')
        historyData = []
      }
      
      // 轉換數據格式以符合元件需求，並過濾當前事件類型的記錄
      
      // 🔒 嚴格過濾：確保兩個主題完全隔離
      const strictlyFilteredData = historyData.filter(item => {
        // 1. 基本事件類型檢查
        const itemEventType = item.event_type || item.eventType
        
        if (!itemEventType) {
          console.warn('⚠️ 發現沒有事件類型的記錄，將被過濾:', item)
          return false
        }
        
        // 2. 標準化比較
        const normalizedItemType = String(itemEventType).trim().toLowerCase()
        const normalizedCurrentType = String(eventType).trim().toLowerCase()
        const basicMatch = normalizedItemType === normalizedCurrentType
        
        // 3. 嚴格的交叉驗證 - 防止標記錯誤的資料
        if (eventType === 'award_speech') {
          // award_speech 應該要有的特徵：較短文字、特定圖片 URL 模式
          const text = item.text || ''
          const imageUrl = item.image_url || item.imageUrl || ''
          
          // 檢查是否有 cheer 的特徵（這些應該被排除）
          const hasCheerFeatures = 
            text.length > 50 || // cheer 文字通常較長
            imageUrl.includes('cheer') ||
            imageUrl.includes('poster') ||
            text.includes('應援') ||
            text.includes('加油') ||
            text.includes('打call')
          
          if (hasCheerFeatures && basicMatch) {
            console.warn('🚫 award_speech 模式下檢測到 cheer 特徵，過濾掉:', {
              itemId: item.id,
              eventType: itemEventType,
              text: text.substring(0, 30) + '...',
              textLength: text.length,
              imageUrl: imageUrl,
              reason: '具有 cheer 特徵'
            })
            return false
          }
          
          // award_speech 應該有的特徵
          const hasAwardFeatures = 
            text.length <= 100 && // 感言卡文字通常較短
            (text.includes('感謝') || text.includes('得獎') || text.includes('感言') || text.length > 0)
          
          if (!hasAwardFeatures && basicMatch) {
            console.warn('⚠️ award_speech 模式下資料不符合感言卡特徵:', {
              itemId: item.id,
              text: text.substring(0, 30) + '...',
              textLength: text.length
            })
          }
        }
        
        if (eventType === 'cheer') {
          // cheer 應該要有的特徵檢查
          const text = item.text || ''
          const imageUrl = item.image_url || item.imageUrl || ''
          
          // 檢查是否有 award_speech 的特徵（這些應該被排除）
          const hasAwardFeatures = 
            text.includes('感謝') ||
            text.includes('得獎') ||
            text.includes('感言') ||
            imageUrl.includes('award') ||
            (text.length > 0 && text.length <= 20 && !text.includes('應援') && !text.includes('加油'))
          
          if (hasAwardFeatures && basicMatch) {
            console.warn('🚫 cheer 模式下檢測到 award_speech 特徵，過濾掉:', {
              itemId: item.id,
              eventType: itemEventType,
              text: text.substring(0, 30) + '...',
              textLength: text.length,
              imageUrl: imageUrl,
              reason: '具有 award_speech 特徵'
            })
            return false
          }
        }
        
        
        return basicMatch
      })
      
      
      apiRecords.value = strictlyFilteredData
        .map((item, index) => ({
          id: item.id || index,
          text: item.text || '',
          imageUrl: item.image_url || item.imageUrl || null,
          created_at: item.created_at || item.timestamp || new Date().toISOString(),
          event_type: item.event_type || item.eventType || eventType, // 確保事件類型存在
          ...item // 保留其他屬性
        }))
      
    } else {
      console.warn('❌ API 回應無效或為空:', result)
      apiRecords.value = []
    }
    
  } catch (error) {
    console.error('❌ 載入圖片歷史失敗:', error)
    apiError.value = error.message
  } finally {
    isLoading.value = false
  }
}

const goBack = () => {
  emit('goBack')
}

const viewHistoryItem = async (item) => {
  try {
    // 如果是從 API 載入的項目且有ID，可以獲取詳細資訊
    if (item.id && apiService.isApiAvailable()) {
      console.log('🔍 查看圖片詳情:', item.id)
      
      try {
        const detailResult = await apiService.getImageDetail(item.id)
        if (detailResult && detailResult.data) {
          // 合併詳細資訊
          const detailedItem = { ...item, ...detailResult.data }
          emit('viewItem', detailedItem)
          return
        }
      } catch (error) {
        console.warn('⚠️ 無法獲取詳細資訊，使用基本資訊:', error.message)
      }
    }
    
    // 使用基本資訊
    emit('viewItem', item)
    
  } catch (error) {
    console.error('❌ 查看項目失敗:', error)
    emit('viewItem', item) // 發生錯誤時仍然嘗試顯示
  }
}

const getHistoryImage = (item) => {
  // 支援多種圖片屬性名稱
  return item.imageUrl || item.image_url || item.poster_image || item.image || null
}

const handleImageError = (event) => {
  console.warn('圖片載入失敗:', event.target.src)
  // 可以在這裡設置預設圖片
  // event.target.src = '/images/default-poster.png'
}

const formatDate = (dateString) => {
  if (!dateString) return ''
  
  const date = new Date(dateString)
  if (isNaN(date.getTime())) {
    // 如果不是有效日期，直接返回原字串
    return dateString
  }
  
  // 格式化為 YYYY/MM/DD HH:mm
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  const hours = String(date.getHours()).padStart(2, '0')
  const minutes = String(date.getMinutes()).padStart(2, '0')
  
  return `${year}/${month}/${day} ${hours}:${minutes}`
}

// 文字覆蓋層樣式函數
const getTextOverlayClass = () => {
  if (eventType === 'award_speech') {
    // 感言卡：文字在白色信紙區域（大約在圖片中央偏上的位置）
    return 'top-[20%] left-[30px] w-[70%]'
  } else {
    // 應援海報：文字居中
    return 'inset-0 flex items-center justify-center'
  }
}

const getTextContainerClass = () => {
  if (eventType === 'award_speech') {
    return 'w-full'  // 使用完整寬度，位置已經在 overlay 層控制
  } else {
    return 'text-center max-w-[90%]'
  }
}

const getTextClass = () => {
  if (eventType === 'award_speech') {
    // 感言卡：黑色文字，稍微大一點以便在小圖中顯示
    return 'text-black font-bold text-[10px] leading-[120%] break-words whitespace-pre-wrap'
  } else {
    // 應援海報：白色文字
    return 'text-white font-bold text-[9px] leading-[110%] break-words whitespace-pre-wrap'
  }
}

const getTextStyle = () => {
  if (eventType === 'award_speech') {
    return {
      wordBreak: 'break-word',
      overflowWrap: 'break-word',
      textAlign: 'left',
      transform: 'rotate(-3deg)',  // 配合信紙角度
      transformOrigin: 'top left'
    }
  } else {
    return {
      textShadow: '1px 1px 2px rgba(0, 0, 0, 0.9)',
      wordBreak: 'break-word',
      overflowWrap: 'break-word'
    }
  }
}
</script>

<style scoped>
.generation-records {
  font-family: 'Noto Serif HK', serif;
}
</style>
